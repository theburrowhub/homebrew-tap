name: Update Formula

on:
  repository_dispatch:
    types: [update-formula]
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to update (e.g., 0.0.2)'
        required: false
      formula:
        description: 'Formula name (krakenv, go-secret, git-gone, cherry-go)'
        required: true
        default: 'krakenv'
        type: choice
        options:
          - krakenv
          - go-secret
          - git-gone
          - cherry-go

jobs:
  update-formula:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout tap
        uses: actions/checkout@v4

      - name: Get formula name
        id: formula
        run: |
          if [ -n "${{ github.event.inputs.formula }}" ]; then
            echo "name=${{ github.event.inputs.formula }}" >> $GITHUB_OUTPUT
          elif [ -n "${{ github.event.client_payload.formula }}" ]; then
            echo "name=${{ github.event.client_payload.formula }}" >> $GITHUB_OUTPUT
          else
            echo "name=krakenv" >> $GITHUB_OUTPUT
          fi

      - name: Get version
        id: version
        env:
          FORMULA: ${{ steps.formula.outputs.name }}
        run: |
          if [ -n "${{ github.event.inputs.version }}" ]; then
            echo "version=${{ github.event.inputs.version }}" >> $GITHUB_OUTPUT
          elif [ -n "${{ github.event.client_payload.version }}" ]; then
            VERSION="${{ github.event.client_payload.version }}"
            VERSION="${VERSION#v}"
            echo "version=$VERSION" >> $GITHUB_OUTPUT
          else
            VERSION=$(curl -s "https://api.github.com/repos/theburrowhub/${FORMULA}/releases/latest" | jq -r '.tag_name' | sed 's/^v//')
            echo "version=$VERSION" >> $GITHUB_OUTPUT
          fi

      - name: Download checksums and update formula
        env:
          VERSION: ${{ steps.version.outputs.version }}
          FORMULA: ${{ steps.formula.outputs.name }}
        run: |
          FORMULA_FILE="Formula/${FORMULA}.rb"
          BASE_URL="https://github.com/theburrowhub/${FORMULA}/releases/download/v${VERSION}"
          
          echo "Updating ${FORMULA} to v${VERSION}..."
          
          # Different projects have different naming conventions
          case "${FORMULA}" in
            "krakenv")
              SHA_DARWIN_ARM64=$(curl -sL "${BASE_URL}/krakenv_${VERSION}_darwin_arm64.tar.gz" | sha256sum | cut -d' ' -f1)
              SHA_DARWIN_AMD64=$(curl -sL "${BASE_URL}/krakenv_${VERSION}_darwin_amd64.tar.gz" | sha256sum | cut -d' ' -f1)
              SHA_LINUX_ARM64=$(curl -sL "${BASE_URL}/krakenv_${VERSION}_linux_arm64.tar.gz" | sha256sum | cut -d' ' -f1)
              SHA_LINUX_AMD64=$(curl -sL "${BASE_URL}/krakenv_${VERSION}_linux_amd64.tar.gz" | sha256sum | cut -d' ' -f1)
              ;;
            "go-secret")
              SHA_DARWIN_ARM64=$(curl -sL "${BASE_URL}/go-secrets_${VERSION}_darwin_arm64.tar.gz" | sha256sum | cut -d' ' -f1)
              SHA_DARWIN_AMD64=$(curl -sL "${BASE_URL}/go-secrets_${VERSION}_darwin_amd64.tar.gz" | sha256sum | cut -d' ' -f1)
              SHA_LINUX_ARM64=$(curl -sL "${BASE_URL}/go-secrets_${VERSION}_linux_arm64.tar.gz" | sha256sum | cut -d' ' -f1)
              SHA_LINUX_AMD64=$(curl -sL "${BASE_URL}/go-secrets_${VERSION}_linux_amd64.tar.gz" | sha256sum | cut -d' ' -f1)
              ;;
            "git-gone")
              SHA_DARWIN_ARM64=$(curl -sL "${BASE_URL}/${FORMULA}_${VERSION}_darwin_arm64.tar.gz" | sha256sum | cut -d' ' -f1)
              SHA_DARWIN_AMD64=$(curl -sL "${BASE_URL}/${FORMULA}_${VERSION}_darwin_amd64.tar.gz" | sha256sum | cut -d' ' -f1)
              SHA_LINUX_ARM64=$(curl -sL "${BASE_URL}/${FORMULA}_${VERSION}_linux_arm64.tar.gz" | sha256sum | cut -d' ' -f1)
              SHA_LINUX_AMD64=$(curl -sL "${BASE_URL}/${FORMULA}_${VERSION}_linux_amd64.tar.gz" | sha256sum | cut -d' ' -f1)
              ;;
            "cherry-go")
              SHA_DARWIN_ARM64=$(curl -sL "${BASE_URL}/${FORMULA}-macos-arm64.tar.gz" | sha256sum | cut -d' ' -f1)
              SHA_DARWIN_AMD64=$(curl -sL "${BASE_URL}/${FORMULA}-macos-amd64.tar.gz" | sha256sum | cut -d' ' -f1)
              SHA_LINUX_ARM64=$(curl -sL "${BASE_URL}/${FORMULA}-linux-arm64.tar.gz" | sha256sum | cut -d' ' -f1)
              SHA_LINUX_AMD64=$(curl -sL "${BASE_URL}/${FORMULA}-linux-amd64.tar.gz" | sha256sum | cut -d' ' -f1)
              ;;
          esac
          
          echo "SHA256 checksums:"
          echo "  darwin_arm64: $SHA_DARWIN_ARM64"
          echo "  darwin_amd64: $SHA_DARWIN_AMD64"
          echo "  linux_arm64: $SHA_LINUX_ARM64"
          echo "  linux_amd64: $SHA_LINUX_AMD64"
          
          # Verify we got valid checksums (not HTML error pages)
          if [[ "$SHA_DARWIN_ARM64" == "0019dfc4b32d63c1392aa264aed2253c1e0c2fb09216f8e2cc269bbfb8bb49b5" ]]; then
            echo "Error: Got invalid checksum (likely 404 page). Check release assets."
            exit 1
          fi
          
          # Update version
          sed -i "s/version \".*\"/version \"${VERSION}\"/" "$FORMULA_FILE"
          
          # Update SHA256 hashes - match lines after URL patterns
          # For on_arm blocks (darwin)
          sed -i "/darwin_arm64/,/sha256/{s/sha256 \"[a-f0-9]*\"/sha256 \"${SHA_DARWIN_ARM64}\"/}" "$FORMULA_FILE"
          # For on_intel blocks (darwin)
          sed -i "/darwin_amd64/,/sha256/{s/sha256 \"[a-f0-9]*\"/sha256 \"${SHA_DARWIN_AMD64}\"/}" "$FORMULA_FILE"
          # For macos-arm64 (git-gone, cherry-go style)
          sed -i "/macos-arm64/,/sha256/{s/sha256 \"[a-f0-9]*\"/sha256 \"${SHA_DARWIN_ARM64}\"/}" "$FORMULA_FILE"
          # For macos-amd64 (git-gone, cherry-go style)
          sed -i "/macos-amd64/,/sha256/{s/sha256 \"[a-f0-9]*\"/sha256 \"${SHA_DARWIN_AMD64}\"/}" "$FORMULA_FILE"
          # For linux_arm64
          sed -i "/linux_arm64/,/sha256/{s/sha256 \"[a-f0-9]*\"/sha256 \"${SHA_LINUX_ARM64}\"/}" "$FORMULA_FILE"
          sed -i "/linux-arm64/,/sha256/{s/sha256 \"[a-f0-9]*\"/sha256 \"${SHA_LINUX_ARM64}\"/}" "$FORMULA_FILE"
          # For linux_amd64
          sed -i "/linux_amd64/,/sha256/{s/sha256 \"[a-f0-9]*\"/sha256 \"${SHA_LINUX_AMD64}\"/}" "$FORMULA_FILE"
          sed -i "/linux-amd64/,/sha256/{s/sha256 \"[a-f0-9]*\"/sha256 \"${SHA_LINUX_AMD64}\"/}" "$FORMULA_FILE"
          
          echo "Updated formula:"
          cat "$FORMULA_FILE"

      - name: Commit and push
        env:
          VERSION: ${{ steps.version.outputs.version }}
          FORMULA: ${{ steps.formula.outputs.name }}
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add Formula/
          git diff --staged --quiet || git commit -m "chore(${FORMULA}): update to v${VERSION}"
          git push
