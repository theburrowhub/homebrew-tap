name: Update Formula

on:
  repository_dispatch:
    types: [update-formula]
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to update (e.g., 0.0.2)'
        required: false
      formula:
        description: 'Formula name (e.g., krakenv)'
        required: false
        default: 'krakenv'

jobs:
  update-formula:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout tap
        uses: actions/checkout@v4

      - name: Get version
        id: version
        run: |
          if [ -n "${{ github.event.inputs.version }}" ]; then
            echo "version=${{ github.event.inputs.version }}" >> $GITHUB_OUTPUT
          elif [ -n "${{ github.event.client_payload.version }}" ]; then
            echo "version=${{ github.event.client_payload.version }}" >> $GITHUB_OUTPUT
          else
            # Fetch latest release from krakenv
            VERSION=$(curl -s https://api.github.com/repos/theburrowhub/krakenv/releases/latest | jq -r '.tag_name' | sed 's/^v//')
            echo "version=$VERSION" >> $GITHUB_OUTPUT
          fi

      - name: Get formula name
        id: formula
        run: |
          if [ -n "${{ github.event.inputs.formula }}" ]; then
            echo "name=${{ github.event.inputs.formula }}" >> $GITHUB_OUTPUT
          elif [ -n "${{ github.event.client_payload.formula }}" ]; then
            echo "name=${{ github.event.client_payload.formula }}" >> $GITHUB_OUTPUT
          else
            echo "name=krakenv" >> $GITHUB_OUTPUT
          fi

      - name: Download and calculate SHA256
        id: sha256
        env:
          VERSION: ${{ steps.version.outputs.version }}
          FORMULA: ${{ steps.formula.outputs.name }}
        run: |
          BASE_URL="https://github.com/theburrowhub/${FORMULA}/releases/download/v${VERSION}"
          
          echo "Downloading artifacts for ${FORMULA} v${VERSION}..."
          
          SHA_DARWIN_ARM64=$(curl -sL "${BASE_URL}/${FORMULA}_${VERSION}_darwin_arm64.tar.gz" | sha256sum | cut -d' ' -f1)
          SHA_DARWIN_AMD64=$(curl -sL "${BASE_URL}/${FORMULA}_${VERSION}_darwin_amd64.tar.gz" | sha256sum | cut -d' ' -f1)
          SHA_LINUX_ARM64=$(curl -sL "${BASE_URL}/${FORMULA}_${VERSION}_linux_arm64.tar.gz" | sha256sum | cut -d' ' -f1)
          SHA_LINUX_AMD64=$(curl -sL "${BASE_URL}/${FORMULA}_${VERSION}_linux_amd64.tar.gz" | sha256sum | cut -d' ' -f1)
          
          echo "sha_darwin_arm64=$SHA_DARWIN_ARM64" >> $GITHUB_OUTPUT
          echo "sha_darwin_amd64=$SHA_DARWIN_AMD64" >> $GITHUB_OUTPUT
          echo "sha_linux_arm64=$SHA_LINUX_ARM64" >> $GITHUB_OUTPUT
          echo "sha_linux_amd64=$SHA_LINUX_AMD64" >> $GITHUB_OUTPUT

      - name: Update formula
        env:
          VERSION: ${{ steps.version.outputs.version }}
          FORMULA: ${{ steps.formula.outputs.name }}
          SHA_DARWIN_ARM64: ${{ steps.sha256.outputs.sha_darwin_arm64 }}
          SHA_DARWIN_AMD64: ${{ steps.sha256.outputs.sha_darwin_amd64 }}
          SHA_LINUX_ARM64: ${{ steps.sha256.outputs.sha_linux_arm64 }}
          SHA_LINUX_AMD64: ${{ steps.sha256.outputs.sha_linux_amd64 }}
        run: |
          FORMULA_FILE="Formula/${FORMULA}.rb"
          
          # Update version
          sed -i "s/version \".*\"/version \"${VERSION}\"/" "$FORMULA_FILE"
          
          # Update SHA256 hashes (match the line after each architecture block)
          sed -i "/darwin_arm64.tar.gz/,/sha256/{s/sha256 \".*\"/sha256 \"${SHA_DARWIN_ARM64}\"/}" "$FORMULA_FILE"
          sed -i "/darwin_amd64.tar.gz/,/sha256/{s/sha256 \".*\"/sha256 \"${SHA_DARWIN_AMD64}\"/}" "$FORMULA_FILE"
          sed -i "/linux_arm64.tar.gz/,/sha256/{s/sha256 \".*\"/sha256 \"${SHA_LINUX_ARM64}\"/}" "$FORMULA_FILE"
          sed -i "/linux_amd64.tar.gz/,/sha256/{s/sha256 \".*\"/sha256 \"${SHA_LINUX_AMD64}\"/}" "$FORMULA_FILE"
          
          cat "$FORMULA_FILE"

      - name: Commit and push
        env:
          VERSION: ${{ steps.version.outputs.version }}
          FORMULA: ${{ steps.formula.outputs.name }}
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add Formula/
          git diff --staged --quiet || git commit -m "chore(${FORMULA}): update to v${VERSION}"
          git push

